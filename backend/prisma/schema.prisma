generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  username  String   @unique
  email     String   @unique
  password  String
  avatar    String?  // Optional avatar URL
  friendIds String[] @db.ObjectId
  fcmTokens String[] @default([]) // FCM device tokens for push notifications
  
  phoneNumber String?
  bio         String?
  displayName String?
  dateOfBirth DateTime?
  
  conversations           Conversation[]   @relation(fields: [conversationIds], references: [id])
  conversationIds         String[]         @db.ObjectId
  
  sentFriendRequests      FriendRequest[]  @relation("Sender")
  receivedFriendRequests  FriendRequest[]  @relation("Receiver")

  messages Message[]
  reactions MessageReaction[]

  createdAt DateTime @default(now())
}

model FriendRequest {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  senderId   String   @db.ObjectId
  receiverId String   @db.ObjectId
  status     String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt  DateTime @default(now())

  sender   User @relation("Sender", fields: [senderId], references: [id])
  receiver User @relation("Receiver", fields: [receiverId], references: [id])

  @@index([senderId])
  @@index([receiverId])
}

model Conversation {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  name           String?
  isGroup        Boolean  @default(false)
  participantIds String[] @db.ObjectId
  lastMessageId  String?  @db.ObjectId
  updatedAt      DateTime @updatedAt

  messages    Message[] @relation("ConversationMessages")
  
  participants User[] @relation(fields: [participantIds], references: [id])
  
  @@index([participantIds])
}

model Message {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String   @db.ObjectId
  senderId       String   @db.ObjectId
  content        String?
  fileUrl        String?
  createdAt      DateTime @default(now())
  
  reactions      MessageReaction[]
  replyToId      String?   @db.ObjectId
  replyTo        Message?  @relation("ReplyTo", fields: [replyToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies        Message[] @relation("ReplyTo")

  sender       User         @relation(fields: [senderId], references: [id])
  conversation Conversation @relation("ConversationMessages", fields: [conversationId], references: [id])
  reads        MessageRead[]

  @@index([conversationId])
  @@index([senderId])
  @@index([conversationId, createdAt])
}

model MessageReaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  userId    String   @db.ObjectId
  emoji     String
  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
}

model ConversationRead {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  conversationId    String   @db.ObjectId
  userId            String   @db.ObjectId
  lastReadMessageId String?  @db.ObjectId
  updatedAt         DateTime @updatedAt

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model MessageRead {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  messageId String   @db.ObjectId
  userId    String   @db.ObjectId
  readAt    DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id])

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}
